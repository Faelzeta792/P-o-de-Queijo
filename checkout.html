<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho | Mineir√≠ssimo Boutique</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{ --cafe:#5D2E0C; --ambar:#F39C12; --bg:#EAE7E1; --white:#fff; --success:#27ae60; }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Montserrat',sans-serif;background:var(--bg);padding:30px 0;color:#333}
        .container{ max-width:1100px; margin:auto; background:var(--white); box-shadow:0 10px 40px rgba(0,0,0,.1); border-radius:4px; display:grid; grid-template-columns:1fr 380px; overflow:hidden; }
        header{ grid-column:1/span 2; padding:25px 50px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .logo{ font-family:'Playfair Display',serif; font-size:24px; color:var(--cafe); text-decoration:none; font-weight:700; }
        .logo span{color:var(--ambar)}
        main{padding:40px 50px}
        h2{ font-family:'Playfair Display',serif; font-size:28px; color:var(--cafe); margin-bottom:30px; }
        .item{ display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #eee; }
        .item h4{font-family:'Playfair Display',serif;color:var(--cafe)}
        
        /* Estilos dos Campos de Entrega */
        .secao-dados { background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 30px; }
        .campo { margin-bottom: 15px; }
        .campo label { display: block; font-size: 11px; font-weight: 700; color: var(--cafe); margin-bottom: 5px; }
        .campo input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; }
        
        aside{ background:#fafafa; padding:40px; border-left:1px solid #eee; }
        .linha{ display:flex; justify-content:space-between; margin-bottom:15px; font-size:14px; }
        .total{ margin-top:25px; padding-top:20px; border-top:2px solid #eee; display:flex; justify-content:space-between; font-size:24px; font-family:'Playfair Display',serif; font-weight:700; color:var(--cafe); }
        
        button{ width:100%; margin-top:15px; border:none; padding:20px; font-size:15px; font-weight:700; border-radius:4px; cursor:pointer; color:white; display:flex; justify-content:center; align-items:center; gap:10px; transition:.3s; }
        .btn-dados { background: var(--cafe); opacity: 0.9; }
        .btn-mp { background: var(--ambar); }
        button:hover{ transform:translateY(-2px); opacity: 1; }
        button:disabled{ background:#ccc; cursor:not-allowed; }
        
        .spinner{ display:none; width:18px; height:18px; border:3px solid rgba(255,255,255,.3); border-top-color:white; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:900px){ .container{grid-template-columns:1fr} aside{border-left:none;border-top:1px solid #eee} }
    </style>
</head>
<body>

<div class="container">
    <header>
        <a href="index.html" class="logo">MINEIR<span>√çSSIMO</span></a>
        <div style="font-size:10px;color:#aaa;font-weight:700;letter-spacing:1px">üîí CHECKOUT SEGURO</div>
    </header>

    <main>
        <h2>Dados de Entrega</h2>
        <div class="secao-dados">
            <div class="campo">
                <label>NOME COMPLETO</label>
                <input type="text" id="nome" placeholder="Como devemos chamar voc√™?">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="campo">
                    <label>CPF</label>
                    <input type="text" id="cpf" placeholder="000.000.000-00">
                </div>
                <div class="campo">
                    <label>WHATSAPP</label>
                    <input type="tel" id="whatsapp" placeholder="(00) 90000-0000">
                </div>
            </div>
            <div class="campo">
                <label>ENDERE√áO COMPLETO</label>
                <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro e cidade">
            </div>
            <button onclick="enviarParaPlanilha()" class="btn-dados" id="btn-envio">
                <span id="texto-envio">Salvar Dados de Entrega</span>
            </button>
        </div>

        <h2>Resumo do Carrinho</h2>
        <div id="lista"></div>
    </main>

    <aside>
        <h3 style="font-family:'Playfair Display',serif;color:var(--cafe);margin-bottom:25px">Pagamento</h3>
        <div class="linha"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
        <div class="linha"><span>Frete</span><span style="color:var(--success);font-weight:700">GR√ÅTIS</span></div>
        <div class="total"><span>Total</span><span id="total">R$ 0,00</span></div>

        <button onclick="pagar()" id="btn-pagar" class="btn-mp" disabled title="Salve os dados de entrega primeiro">
            <div class="spinner" id="spinner"></div>
            <span id="texto-btn">Pagar com Mercado Pago</span>
        </button>
    </aside>
</div>

<script>
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    const lista = document.getElementById("lista");
    const subtotalEl = document.getElementById("subtotal");
    const totalEl = document.getElementById("total");

    if (carrinho.length === 0) {
        lista.innerHTML = "<p>Seu carrinho est√° vazio.</p>";
    }

    let valorTotal = 0;
    carrinho.forEach(prod => {
        const linha = document.createElement("div");
        linha.className = "item";
        linha.innerHTML = `
            <div>
                <h4>${prod.title}</h4>
                <small style="color:#888">Quantidade: ${prod.quantity}</small>
            </div>
            <span>R$ ${(prod.price * prod.quantity).toFixed(2).replace('.', ',')}</span>
        `;
        lista.appendChild(linha);
        valorTotal += prod.price * prod.quantity;
    });

    subtotalEl.innerText = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
    totalEl.innerText = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;

    // --- FUN√á√ÉO DE ENVIO PARA GOOGLE SHEETS ---
    async function enviarParaPlanilha() {
        const btn = document.getElementById("btn-envio");
        const texto = document.getElementById("texto-envio");
        
        const dados = {
            nome: document.getElementById("nome").value,
            cpf: document.getElementById("cpf").value,
            whatsapp: document.getElementById("whatsapp").value,
            endereco: document.getElementById("endereco").value,
            pedido: carrinho.map(p => `${p.quantity}x ${p.title}`).join(', '),
            total: document.getElementById("total").innerText
        };

        if(!dados.nome || !dados.cpf || !dados.endereco) return alert("Por favor, preencha todos os dados de entrega!");

        btn.disabled = true;
        texto.innerText = "Salvando dados...";

        // URL do seu Google Apps Script (App Web)
        const URL_WEB_APP = "https://script.google.com/macros/s/AKfycbwdSbxjUkjsLvpSQZKOmdQViuPpL59gKcOSeUIgxMEANlMscrNH4sMWDJVpX9vC1A0s/exec";

        try {
            await fetch(URL_WEB_APP, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });
            
            texto.innerText = "‚úì Dados Salvos!";
            btn.style.background = "#27ae60";
            // Libera o bot√£o de pagamento ap√≥s salvar os dados
            document.getElementById("btn-pagar").disabled = false;
        } catch (e) {
            console.error(e);
            alert("Erro ao salvar dados. Tente novamente.");
            btn.disabled = false;
            texto.innerText = "Tentar novamente";
        }
    }

    // --- FUN√á√ÉO MERCADO PAGO ---
    async function pagar(){
        const btn = document.getElementById("btn-pagar");
        const textoBtn = document.getElementById("texto-btn");
        const spinner = document.getElementById("spinner");

        btn.disabled = true;
        textoBtn.innerText = "Conectando...";
        spinner.style.display = "block";

        const payload = {
            items: carrinho.map(p => ({
                title: p.title,
                unit_price: p.price,
                quantity: p.quantity
            }))
        };

        try {
            const res = await fetch("/api/finalizar-compra", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (data.init_point) {
                window.location.href = data.init_point;
            } else {
                throw new Error("Erro no link");
            }
        } catch (e) {
            alert("Erro ao iniciar pagamento. Verifique sua conex√£o.");
            btn.disabled = false;
            textoBtn.innerText = "Pagar com Mercado Pago";
            spinner.style.display = "none";
        }
    }
</script>

</body>
</html>
</html>

