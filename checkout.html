<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento | Mineiríssimo</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --cafe: #5D2E0C; --ambar: #F39C12; --bg: #EAE7E1; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .caixa-pagamento { max-width: 500px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { font-family: 'Playfair Display', serif; color: var(--cafe); margin-bottom: 20px; text-align: center; }
        .item-resumo { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .total { font-size: 22px; font-weight: 700; color: var(--cafe); text-align: right; margin: 20px 0; }
        #btn-pagar { width: 100%; background: var(--ambar); color: white; border: none; padding: 20px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 16px; }
        #btn-pagar:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="caixa-pagamento">
    <h2>Seu Pedido</h2>
    <div id="lista-itens"></div>
    <div class="total" id="valor-total">Total: R$ 0,00</div>
    
    <button id="btn-pagar" onclick="processarPagamento()">Pagar com Pix Agora</button>
</div>

<script>
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    const listaEl = document.getElementById("lista-itens");
    const totalEl = document.getElementById("valor-total");
    let valorFinal = 0;

    // Renderiza os produtos que vieram do index
    if (carrinho.length === 0) {
        listaEl.innerHTML = "<p>Seu carrinho está vazio, uai!</p>";
        document.getElementById("btn-pagar").disabled = true;
    } else {
        carrinho.forEach(item => {
            const div = document.createElement("div");
            div.className = "item-resumo";
            div.innerHTML = `<span>${item.quantity}x ${item.title}</span> <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>`;
            listaEl.appendChild(div);
            valorFinal += item.price * item.quantity;
        });
        totalEl.innerText = `Total: R$ ${valorFinal.toFixed(2).replace('.', ',')}`;
    }

    async function processarPagamento() {
        const btn = document.getElementById("btn-pagar");
        btn.disabled = true;
        btn.innerText = "Gerando QR Code...";

        try {
            const res = await fetch("/api/finalizar-compra", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ total: valorFinal, email: "cliente@pao.com", items: carrinho })
            });

            const data = await res.json();

            if (data.qr_code_base64) {
                // Mostra o QR Code na tela
                document.querySelector(".caixa-pagamento").innerHTML = `
                    <div style="text-align:center">
                        <h2>Escaneie o Pix</h2>
                        <img src="data:image/png;base64,${data.qr_code_base64}" width="250">
                        <p style="margin-top:20px; color:var(--ambar)"><strong>Aguardando pagamento...</strong></p>
                        <p style="font-size:12px">O site mudará sozinho após o banco confirmar.</p>
                    </div>
                `;

                // Começa a vigiar o pagamento
                const interval = setInterval(async () => {
                    const check = await fetch(`/api/verificar-pagamento?id=${data.id}`);
                    const status = await check.json();
                    if (status.status === 'approved') {
                        clearInterval(interval);
                        localStorage.removeItem("carrinho"); // Limpa o carrinho
                        window.location.href = "sucesso.html";
                    }
                }, 3000);
            }
        } catch (e) {
            alert("Erro ao gerar Pix. Tente novamente.");
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
